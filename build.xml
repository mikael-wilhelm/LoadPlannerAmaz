<project name="AmazonPublisher">

    <target name="propTest">
        <property file="/var/lib/jenkins/greenBlueServers.properties"/>
        <condition property="isGreen">
            <equals arg1="${serverSet}" arg2="green"/>
        </condition>
        <condition property="isBlue">
            <equals arg1="${serverSet}" arg2="blue"/>
        </condition>
    </target>

    <target name="test" depends="propTest" if="isGreen">
        <!--todo: stop tomcat-->
        <scp file="main/target/main-1.0-SNAPSHOT.war"
             todir="ubuntu@23.23.208.227:/home/ubuntu/env/tomcat/webapps/"
             trust="true"
             keyfile="${user.home}/.ssh/amazKey.pem"/>
        <!--todo: start tomcat-->
        <waitfor maxwait="3" maxwaitunit="minute">
            <and>
                <http url="http://23.23.208.227:8080/main-1.0-SNAPSHOT"/>
            </and>
        </waitfor>
        <replace file="/var/lib/jenkins/greenBlueServers.properties" token="green" value="blue"/>
        <replace file="index.html" token="address" value="http://23.23.208.227:8080/main-1.0-SNAPSHOT/"/>

        <scp file="index.html"
             todir="ubuntu@ec2-23-22-55-131.compute-1.amazonaws.com:/var/www"
             trust="true"
             keyfile="${user.home}/.ssh/amazKey.pem"/>
    </target>

    <target name="test2" depends="test" if="isBlue">
        <!--todo: stop tomcat-->
        <scp file="main/target/main-1.0-SNAPSHOT.war"
        todir="ubuntu@23.23.182.102:/home/ubuntu/env/tomcat/webapps/"
        trust="true"
        keyfile="${user.home}/.ssh/amazKey.pem"/>
        <!--todo: start tomcat-->
        <waitfor maxwait="3" maxwaitunit="minute">
            <and>
                <http url="http://23.23.182.102:8080/main-1.0-SNAPSHOT"/>
            </and>
        </waitfor>
        <replace file="/var/lib/jenkins/greenBlueServers.properties" token="blue" value="green"/>
        <replace file="index.html" token="address" value="http://23.23.182.102:8080/main-1.0-SNAPSHOT/"/>

        <scp file="index.html"
             todir="ubuntu@ec2-23-22-55-131.compute-1.amazonaws.com:/var/www"
             trust="true"
             keyfile="${user.home}/.ssh/amazKey.pem"/>
    </target>



</project>